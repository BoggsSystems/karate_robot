#!/usr/bin/env python3
"""
ROS 2 bridge node that maps strategist intent into the hardware contract.
Bushido note: intent is welcomed, but justice shapes the final command.
"""

from typing import Dict, List

import rclpy
from rclpy.node import Node
from sensor_msgs.msg import JointState
from std_msgs.msg import Float64MultiArray, Int16MultiArray
from trajectory_msgs.msg import JointTrajectory, JointTrajectoryPoint


class RegisterBridge(Node):
    def __init__(self):
        super().__init__("register_bridge")

        self.declare_parameter("fixed_scale", 1000.0)
        self.declare_parameter(
            "joint_names",
            [
                "shoulder_pan",
                "shoulder_lift",
                "upper_arm_roll",
                "elbow_flex",
                "forearm_roll",
                "wrist_flex",
                "wrist_roll",
            ],
        )

        self.fixed_scale = float(self.get_parameter("fixed_scale").value)
        self.joint_names: List[str] = list(self.get_parameter("joint_names").value)
        self.joint_index: Dict[str, int] = {
            name: idx for idx, name in enumerate(self.joint_names)
        }

        self.target_angles = [0] * len(self.joint_names)
        self.actual_angles = [0] * len(self.joint_names)

        self.create_subscription(
            Float64MultiArray, "desired_pose", self.on_desired_pose, 10
        )
        self.create_subscription(JointState, "joint_states", self.on_joint_state, 10)

        self.register_target_pub = self.create_publisher(
            Int16MultiArray, "register_map/target_angles", 10
        )
        self.register_actual_pub = self.create_publisher(
            Int16MultiArray, "register_map/actual_angles", 10
        )
        self.trajectory_pub = self.create_publisher(
            JointTrajectory, "arm_controller/joint_trajectory", 10
        )

        self.get_logger().info("Register bridge online.")

    def clamp_fixed14(self, value: int) -> int:
        return max(-8192, min(8191, value))

    def to_fixed14(self, radians: float) -> int:
        # Fixed-point scaling in mrad by default; adjust via fixed_scale param.
        scaled = int(round(radians * self.fixed_scale))
        return self.clamp_fixed14(scaled)

    def on_desired_pose(self, msg: Float64MultiArray) -> None:
        if len(msg.data) != len(self.joint_names):
            self.get_logger().warn(
                "desired_pose length mismatch; expected %d got %d",
                len(self.joint_names),
                len(msg.data),
            )
            return

        for i, angle in enumerate(msg.data):
            self.target_angles[i] = self.to_fixed14(angle)

        self.publish_registers()
        self.publish_trajectory(msg.data)

    def on_joint_state(self, msg: JointState) -> None:
        for name, position in zip(msg.name, msg.position):
            idx = self.joint_index.get(name)
            if idx is None:
                continue
            self.actual_angles[idx] = self.to_fixed14(position)

        self.publish_registers()

    def publish_registers(self) -> None:
        target_msg = Int16MultiArray(data=self.target_angles)
        actual_msg = Int16MultiArray(data=self.actual_angles)
        self.register_target_pub.publish(target_msg)
        self.register_actual_pub.publish(actual_msg)

    def publish_trajectory(self, positions: List[float]) -> None:
        traj = JointTrajectory()
        traj.joint_names = self.joint_names
        point = JointTrajectoryPoint()
        point.positions = list(positions)
        point.time_from_start.sec = 1
        traj.points.append(point)
        self.trajectory_pub.publish(traj)


def main() -> None:
    rclpy.init()
    node = RegisterBridge()
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    node.destroy_node()
    rclpy.shutdown()


if __name__ == "__main__":
    main()
