# Sensei CAD and Fusion 360 Automation

This directory holds CAD parameters, export config, and Fusion 360 scripts for automating the Sensei robot hardware workflow. See `docs/frame_cad_design.md` for the full design plan.

## Directory layout

```
cad/
├── assemblies/          # sensei_full.step, .f3d, .fcstd (generated)
├── parts/               # STL by subassembly (torso, arm_left, leg_left, …)
├── sensei_params.yaml   # Master params: robot, xl430, bracket, urdf_links, urdf_joints
├── detail_params.yaml   # TorsoMain, LimbTubeWithChannel, FootWithFSR (exposed-electronics)
├── urdf_geometry.json   # Generated by urdf_to_cad_params; used by GenerateFromParams
├── export_config.json   # Fusion export: body/component name → STL/STEP path
├── export_config.yaml   # Same mapping (YAML) for editing; Fusion uses .json
├── fusion_scripts/
│   ├── export_to_cad/     # Fusion: export parts to STL, assembly to STEP
│   ├── GenerateFromParams/  # Fusion: create bodies from urdf_geometry.json
│   ├── BodiesToComponents/  # Fusion: bodies → components, name from body.name
│   ├── PlaceFromUrdf/      # Fusion: position occurrences from urdf_geometry joints
│   ├── xl430_bracket/     # Fusion: parametric XL430 servo bracket
│   ├── TorsoMain/         # Fusion: open-front torso, cavity, Pi/Teensy bosses, battery tray
│   ├── LimbTubeWithChannel/  # Fusion: tube + open cable channel per limb link
│   └── FootWithFSR/       # Fusion: foot with FSR pockets on sole
└── README.md            # This file
```

---

## 1. URDF → `sensei_params.yaml`, `urdf_geometry.json`, `export_config.json`

**Script:** `scripts/urdf_to_cad_params.py`

Pulls geometry (box, cylinder, sphere) and joint data from `simulation/urdf/*.urdf.xacro` and:
- Merges into `cad/sensei_params.yaml` under `urdf_links` and `urdf_joints`
- Writes `cad/urdf_geometry.json` for the Fusion **GenerateFromParams** script
- Updates `cad/export_config.json` with link-name → STL path for generated bodies

Run after URDF changes so Fusion scripts and docs stay in sync.

**Requirements:** `pip install -r scripts/requirements.txt` (PyYAML).

```bash
# From repo root
python3 scripts/urdf_to_cad_params.py

# Options
python3 scripts/urdf_to_cad_params.py --urdf-dir simulation/urdf --output cad/sensei_params.yaml
```

---

## 2. Fusion 360 URDF exporter (Fusion → ROS 2)

To use **Fusion as the source of truth** and export URDF + STL for ROS 2 / Gazebo:

1. **Install [fusion360-urdf-ros2](https://github.com/runtimerobotics/fusion360-urdf-ros2):**
   - Download the repo and open Fusion 360.
   - **Shift+S** → Scripts and Add-Ins → **Add-Ins** → green **+** → **Add-in from your computer**.
   - Choose the `Fusion_URDF_Exporter_ROS2` folder.
   - The add-in appears under **My Add-Ins**.

2. **Design rules** (from the add-in docs):
   - Root link component: **`base_link`**.
   - One component per link; no nested components.
   - Use **As-built Joints** (Rigid, Revolute, Slider); parent = Component2.
   - Follow the right-hand rule (e.g. +X forward, +Z up for ROS 2).

3. **Export:** Run the add-in from Scripts and Add-Ins; pick the folder for the ROS 2 description package. It generates URDF, STL, and launch files.

---

## 3. Fusion scripts (export, brackets, exposed-electronics generators)

Fusion scripts run **inside** Fusion 360 (UTILITIES → Scripts and Add-Ins, **Shift+S**). Add the script folder via **Create** → **Script from your computer** (or **Add-in from your computer** for a toolbar entry), then run it from the list.

**CAD root:** Scripts assume the `cad/` folder is two levels above the script, e.g.:

- `cad/fusion_scripts/export_to_cad/ExportToCad.py` → `cad/` = `export_to_cad/../../`

If you install the script elsewhere, ensure `cad/export_config.json` and `cad/assemblies/`, `cad/parts/` are where the script expects, or it will prompt.

### 3.1 Export to CAD (`export_to_cad`)

- **Role:** Export each configured part to `cad/parts/<subdir>/<name>.stl` and the full assembly to `cad/assemblies/sensei_full.step`. Exports **components** (occurrences) or **bodies** by name (e.g. from GenerateFromParams or Xl430Bracket).
- **Config:** `cad/export_config.json`. Keys under `parts` are Fusion **body or component names**; values are paths under `cad/` (e.g. `parts/torso/torso_main.stl`). `assembly.step` is the STEP path.
- **Run:** Open your Sensei design in Fusion, run **ExportToCad**. Only parts that exist (as a component or a body) and are listed in the config are exported.

**If you add parts:** Edit `export_config.json` (or `export_config.yaml` and recreate `.json` if you use that), adding `"part_name": "parts/subdir/name.stl"`. Running `urdf_to_cad_params.py` adds URDF link names automatically.

### 3.2 GenerateFromParams (`GenerateFromParams`)

- **Role:** Create **bodies** for all URDF links from `cad/urdf_geometry.json` (box, cylinder; sphere as cylinder). Run **after** `urdf_to_cad_params.py`. Design units: mm.
- **Run:** In a Fusion design (empty or with existing bodies), run **GenerateFromParams**. It creates one body per link (e.g. `base_link`, `l_upper_arm_link`, `l_foot_link`). Then run **ExportToCad** to write STLs. Bodies are created at the origin and may overlap; move or hide as needed.

### 3.3 XL430 bracket (`xl430_bracket`)

- **Role:** Create a parametric **xl430_bracket** **body**: outer tray, inner pocket for the servo, and 4× M2.5 mounting holes. Dimensions match `docs/frame_cad_design.md` and `cad/sensei_params.yaml` (wall, clearance, hole pattern). Use for manufacturing-grade brackets; GenerateFromParams gives simple stand-ins.
- **Design units:** mm.
- **Run:** In a Fusion design (can be empty), run **Xl430Bracket**. The body is added in the root. Then run **ExportToCad** to write `parts/torso/xl430_bracket.stl` (if that mapping exists in `export_config.json`).

To change dimensions, edit the constants at the top of `Xl430Bracket.py` (e.g. `SERVO_W`, `WALL`, `HOLE_HW`, `HOLE_HD`). For the exact XL430 hole pattern, see the [Dynamixel e-manual](https://emanual.robotis.com/docs/en/dxl/x/xl430-w250/).

### 3.4 TorsoMain, LimbTubeWithChannel, FootWithFSR (exposed-electronics)

These generate hardware that matches the **reference image** (open chest, visible cable runs, Pi/Teensy bosses, flat LiPo tray, FSR on sole). See **`docs/fusion_image_to_hardware.md`** for the full workflow and **`cad/detail_params.yaml`** for dimensions.

- **TorsoMain:** Open-front torso 200×140×100 mm, cavity 100×80×40, Pi boss (4× M2.5 standoffs), battery tray 105×35×20, cable passthroughs. Body `torso_main`.
- **LimbTubeWithChannel:** Reads `urdf_geometry.json`, creates a cylinder with an **open cable channel** (8×4 mm) for each limb link (`l_upper_arm_link`, `l_forearm_link`, …). Replaces simple cylinders with tube+channel for visible wiring.
- **FootWithFSR:** Foot 100×60×30 mm, two **FSR pockets on the underside** (ball and heel). Body `foot_with_fsr`; duplicate for `l_foot_link` / `r_foot_link`.

Run each from Scripts and Add-Ins. Use **Replace Component** in the assembly to swap placeholders from GenerateFromParams, or build the assembly from these parts and run PlaceFromUrdf.

---

## 4. `sensei_params.yaml` and `export_config`

- **`sensei_params.yaml`**  
  - `robot`, `xl430`, `bracket`, `xl430_hole_pattern_mm`: from `docs/frame_cad_design.md`; edit by hand.  
  - `urdf_links`, `urdf_joints`: filled by `urdf_to_cad_params.py`; do not edit manually if you re-run the script.  
  - `export_parts`: list of part names by subassembly; for reference and for keeping `export_config` in sync.

- **`urdf_geometry.json`**  
  - Written by `urdf_to_cad_params.py`. **parts**: used by **GenerateFromParams** (name, type, dimensions, origin_xyz). **joints**: used by **PlaceFromUrdf** (name, type, parent, child, origin_xyz, origin_rpy, axis). Do not edit by hand.

- **`export_config.json`**  
  - Used by `export_to_cad`. Updated by `urdf_to_cad_params.py` with link-name → path.  
  - You can maintain `export_config.yaml` and convert to JSON when needed, or edit `export_config.json` directly for custom parts.

---

## 5. Suggested workflow

1. **URDF → params and geometry**
   - Edit `simulation/urdf/*.urdf.xacro` or `docs/frame_cad_design.md` as needed.
   - Run:  
     `python3 scripts/urdf_to_cad_params.py`  
     to update `sensei_params.yaml`, `urdf_geometry.json`, and `export_config.json`.

2. **Fusion: generate and design**
   - **Create a design** (or open an existing one).
   - Run **GenerateFromParams** to create bodies for all URDF links (box/cylinder) in one shot.
   - Optionally run **Xl430Bracket** (and later other detail scripts) for manufacturing-grade parts. Move or hide bodies as needed.
   - Refine geometry by hand if desired.

3. **Fusion: export**
   - Run **ExportToCad** to write `cad/parts/**/*.stl` and `cad/assemblies/sensei_full.step` for all bodies/components listed in `export_config.json`.

4. **Fusion → ROS 2 (optional)**
   - Use the **fusion360-urdf-ros2** add-in to export URDF + meshes into a ROS 2 description package, then point your `simulation/` or `*_description` at that package as needed.

---

## 6. Assembling the robot in Fusion

See **`docs/fusion_assembly_roadmap.md`** for the full roadmap. Use an **Assembly** design (not Part Design) for **BodiesToComponents** and **PlaceFromUrdf** — Part Design allows only one component. **API automation:**

- **BodiesToComponents** — Convert each body to a component and name it (`body.createComponent()`, `component.name = body.name`). Run after GenerateFromParams.
- **PlaceFromUrdf** — Read `urdf_geometry.json` → **joints**, compute each link’s world transform from `base_link`, set `occurrence.transform2`. Run after BodiesToComponents. **Joints** (Rigid/Revolute) are still added manually; the Joint API needs geometry (faces/edges/points), not only (x,y,z) and axis.

---

## 7. References

- [Fusion 360 API](https://help.autodesk.com/cloudhelp/ENU/Fusion-360-API/)
- [fusion360-urdf-ros2](https://github.com/runtimerobotics/fusion360-urdf-ros2)
- [Dynamixel XL430 e-manual](https://emanual.robotis.com/docs/en/dxl/x/xl430-w250/)
- `docs/frame_cad_design.md`
- `docs/fusion_assembly_roadmap.md`
- `docs/fusion_image_to_hardware.md` — match the reference image (open chest, cable channels, FSR on sole)
